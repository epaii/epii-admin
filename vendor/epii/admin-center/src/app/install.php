<?php
/**
 * Created by PhpStorm.
 * User: mrren
 * Date: 2019/1/12
 * Time: 10:01 AM
 */

namespace epii\admin\center\app;


use epii\admin\center\common\_controller;
use epii\admin\center\libs\Tools;
use epii\admin\ui\lib\epiiadmin\jscmd\Alert;
use epii\admin\ui\lib\epiiadmin\jscmd\JsCmd;

class install extends _controller
{

    private static $is_install = null;

    public function init()
    {
        if (self::isInstall() !== false) {
            header("location:" . Tools::get_web_root());
            exit;
        }
        parent::init(); // TODO: Change the autogenerated stub
    }


    public function index()
    {

        $this->adminUiDisplay("install/index", "安装程序");
    }

    public function config()
    {


        if ($_POST) {
            $config_dir = Tools::getVendorDir() . "/../config";

            if (!is_dir($config_dir)) {
                if (!mkdir($config_dir, 0777, true)) {
                    return JsCmd::make()->addCmd(Alert::make()->msg("请确保有创建文件夹" . $config_dir . "的权限")->onOk(null))->run();
                }
            }


            $config = $_POST;
            $link = mysqli_connect($config["hostname"], $config["username"], $config["password"], '', $config["hostport"]);

            if (!$link) {
                return JsCmd::make()->addCmd(Alert::make()->msg("数据库设置错误，检查账号或密码是否正确"))->run();

            }


            $db_has = mysqli_query($link, "use " . $config["database"]);
            if (!$db_has) {
                return JsCmd::make()->addCmd(Alert::make()->msg("数据库不存在"))->run();
            }

            $sql = file_get_contents(__DIR__ . "/../config/install.sql");

            $sql = str_replace("`epii_", "`" . $config["prefix"], $sql);

            $_arr = explode(';', $sql);

            foreach ($_arr as $_value) {
                if ($_value = trim($_value)) {
                    $query_info = mysqli_query($link, $_value);


                    if ($query_info === false) {

                        return JsCmd::make()->addCmd(Alert::make()->msg("安装失败"))->run();
                    }
                }

            }

            $query_info =   mysqli_query($link, "update `".$config["prefix"]."admin` set username='".$config["admin_username"]."', password='".md5($config["admin_password"])."'  where id=1");



            if ($query_info === false) {

                return JsCmd::make()->addCmd(Alert::make()->msg("安装失败,默认账号密码失败！"))->run();
            }


            mysqli_commit($link);


            mysqli_close($link);
            unset($config["admin_username"]);
            unset($config["admin_password"]);
            $config["type"]="mysql";
            file_put_contents(Tools::getVendorDir() . "/../config/db.conf.php", "<?php return  " . var_export($config, true) . " ;");
            return JsCmd::alertCloseRefresh("安装成功");
        } else {
            $this->adminUiDisplay("install/config", "安装程序");
        }

    }


    public static function isInstall()
    {
        if (self::$is_install === null) {
            if (file_exists(Tools::getVendorDir() . "/../config/db.conf.php")) {
                self::$is_install = true;
            } else {
                self::$is_install = false;
            }
        }
        return self::$is_install;

    }

}

 